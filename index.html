<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rossöhamn – Automation & Data</title>
  <meta name="description" content="Rossöhamn – automatisering, datahantering och elpriser." />

  <!-- Samma bas-stil som spotprices -->
  <link rel="stylesheet" href="/spotprices/styles.css" />

  <!-- Endast startsidans tillägg -->
  <link rel="stylesheet" href="/assets/home.css" />
</head>

<body>
<main class="wrap">

  <!-- HEADER -->
  <header class="card">
    <div class="row row-space">
      <div class="row">
        <div class="title">Rossöhamn – Automation</div>
        <span class="pill">data</span>
        <span class="pill">jobs</span>
        <span class="pill">spotpriser</span>
      </div>

      <nav class="row nav">
        <a class="navlink active" href="/">Hem</a>
        <a class="navlink" href="#automation">Automation</a>
        <a class="navlink" href="#aktuellt">Aktuellt</a>
        <a class="navlink cta" href="/spotprices/">Spotpriser</a>
      </nav>
    </div>

    <p class="meta" style="margin-top:10px;">
      Startsida för automatisering och annan datahantering.  
      Spotpriser är första publika verktyget.
    </p>
  </header>

  <!-- MINI-GRAF -->
  <section class="card">
    <div class="row row-space">
      <div class="row">
        <div class="title">Dagens elpris</div>
        <span class="pill" id="mini-status">laddar…</span>
      </div>
      <a class="btn" href="/spotprices/">Öppna spotpriser</a>
    </div>

    <a href="/spotprices/" class="miniChartLink">
      <svg id="spark" viewBox="0 0 1000 180" preserveAspectRatio="none">
        <rect width="1000" height="180" class="spark-bg"></rect>
        <path id="sparkFill" class="spark-fill"></path>
        <path id="sparkLine" class="spark-line"></path>
        <text id="sparkText" x="14" y="26" class="spark-text">Hämtar data…</text>
      </svg>
    </a>

    <div class="row small">
      <span id="mini-meta"></span>
    </div>
  </section>

  <!-- AUTOMATION -->
  <section class="card" id="automation">
    <div class="row row-space">
      <div class="title">Automation</div>
      <span class="pill">översikt</span>
    </div>

    <div class="grid">
      <div class="tile">
        <div class="tile-title">Senaste uppdatering</div>
        <div class="small" id="sys-updated">—</div>
        <div class="meta">history.json</div>
      </div>

      <div class="tile">
        <div class="tile-title">Systemstatus</div>
        <div class="small" id="sys-status">—</div>
        <div class="meta">Datapipeline</div>
      </div>

      <a class="tile" href="/spotprices/">
        <div class="tile-title">Spotpriser</div>
        <div class="small">Dashboard</div>
        <div class="meta">Graf · tabell · historik</div>
      </a>

      <div class="tile">
        <div class="tile-title">Kommande</div>
        <div class="small">—</div>
        <div class="meta">Fler datakällor</div>
      </div>
    </div>
  </section>

  <!-- AKTUELLT -->
  <section class="card" id="aktuellt">
    <div class="row row-space">
      <div class="title">Aktuellt</div>
      <span class="pill">notiser</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:140px;">Datum</th>
          <th>Information</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="small">—</td>
          <td>Spotpriser uppdateras dagligen via automatiserad pipeline.</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- FOOTER -->
  <footer class="card">
    <div class="row row-space">
      <div class="small">© <span id="year"></span> Rossöhamn</div>
      <div class="row">
        <a class="navlink" href="/spotprices/">Spotpriser</a>
        <a class="navlink" href="#automation">Automation</a>
        <a class="navlink" href="#aktuellt">Aktuellt</a>
      </div>
    </div>
  </footer>

</main>

<!-- SCRIPT -->
<script>
  document.getElementById("year").textContent = new Date().getFullYear();

  const DATA_URL = "/spotprices/history.json";

  function todayKeySE() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function drawSpark(points, label) {
    const W=1000,H=180,p=14;
    const line=document.getElementById("sparkLine");
    const fill=document.getElementById("sparkFill");
    const text=document.getElementById("sparkText");

    if(points.length<2){ text.textContent="Ingen data"; return; }

    const min=Math.min(...points), max=Math.max(...points);
    const span=max-min||1;
    const xs=(W-p*2)/(points.length-1);
    const y=v=>(H-p)-((v-min)/span)*(H-p*2);

    let d="";
    points.forEach((v,i)=>{
      d+=`${i?"L":"M"}${p+i*xs} ${y(v)} `;
    });

    line.setAttribute("d",d);
    fill.setAttribute("d",`${d}L ${p+(points.length-1)*xs} ${H-p} L ${p} ${H-p} Z`);
    text.textContent="";
    document.getElementById("mini-meta").textContent =
      `Min ${min.toFixed(1)} öre · Max ${max.toFixed(1)} öre (${label})`;
    document.getElementById("mini-status").textContent="ok";
  }

  async function loadMini(){
    try{
      const r=await fetch(DATA_URL,{cache:"no-store"});
      const j=await r.json();
      const key=todayKeySE();
      const day=j.days?.[key];
      const pts=day?.points?.map(p=>p.oreKwh).filter(Number.isFinite)||[];
      drawSpark(pts,key);

      document.getElementById("sys-updated").textContent =
        new Date(j.meta.updatedAt).toLocaleString("sv-SE");
      document.getElementById("sys-status").textContent = "OK";
    }catch{
      document.getElementById("mini-status").textContent="fel";
      document.getElementById("sys-status").textContent="Fel";
    }
  }

  loadMini();
</script>
</body>
</html>
