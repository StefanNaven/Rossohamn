<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rossöhamn</title>
  <meta name="description" content="Rossöhamn – nyheter, automation och verktyg." />

  <!-- Samma bas-stil som spotprices -->
  <link rel="stylesheet" href="/spotprices/styles.css" />

  <!-- Startsidan: layout & komponenter -->
  <link rel="stylesheet" href="/assets/home.css" />
</head>

<body>
<main class="wrap">

  <!-- Header -->
  <header class="card hero">
    <div class="row row-space">
      <div class="row">
        <div class="title">Rossöhamn</div>
        <span class="pill">hem</span>
        <span class="pill">automation</span>
        <span class="pill">info</span>
      </div>

      <nav class="row nav" aria-label="Huvudmeny">
        <a class="navlink active" href="/">Hem</a>
        <a class="navlink" href="#aktuellt">Aktuellt</a>
        <a class="navlink" href="#automation">Automation</a>
        <a class="navlink" href="#elpriser">Elpriser</a>
        <a class="navlink" href="#whatsmyip">What’s my IP</a>
        <a class="navlink cta" href="/spotprices/">Spotpriser</a>
      </nav>
    </div>

    <p class="meta" style="margin-top:10px;">
      Samlingssida för nyheter, information och verktyg. Här kan du senare lägga till fler delar (t.ex. Homey-data).
    </p>
  </header>

  <!-- Top row: Aktuellt + What's my IP -->
  <section class="twoCol">
    <!-- Segment: Aktuellt / Nyheter -->
    <section class="card" id="aktuellt">
      <div class="row row-space">
        <div class="title">Aktuellt</div>
        <span class="pill">nyheter</span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px;">Datum</th>
            <th>Information</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="small">—</td>
            <td>Här kan du publicera notiser till andra (fritid, hamninfo, uppdateringar).</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- What's my IP -->
    <section class="card" id="whatsmyip">
      <div class="row row-space">
        <div class="title">What’s my IP</div>
        <span class="pill" id="ip-status">laddar…</span>
      </div>

      <div class="kv">
        <div class="kv-row">
          <div class="small">Public IP</div>
          <div class="meta" id="ip-public">—</div>
        </div>
        <div class="kv-row">
          <div class="small">ISP / ASN</div>
          <div class="meta" id="ip-isp">—</div>
        </div>
        <div class="kv-row">
          <div class="small">Plats</div>
          <div class="meta" id="ip-loc">—</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" type="button" id="ip-refresh">Uppdatera</button>
        <span class="small" id="ip-note"></span>
      </div>
    </section>
  </section>

  <!-- Segment: Automation -->
  <section class="card" id="automation">
    <div class="row row-space">
      <div class="title">Automation</div>
      <span class="pill">översikt</span>
    </div>

    <div class="grid">
      <div class="tile">
        <div class="tile-title">Systemstatus</div>
        <div class="small" id="sys-status">—</div>
        <div class="meta">Datapipeline</div>
      </div>

      <div class="tile">
        <div class="tile-title">Senaste uppdatering</div>
        <div class="small" id="sys-updated">—</div>
        <div class="meta">history.json</div>
      </div>

      <a class="tile" href="/spotprices/">
        <div class="tile-title">Spotpriser</div>
        <div class="small">Dashboard</div>
        <div class="meta">Graf · tabell · historik</div>
      </a>

      <div class="tile">
        <div class="tile-title">Homey (framtid)</div>
        <div class="small">—</div>
        <div class="meta">Status/metrics</div>
      </div>
    </div>
  </section>

  <!-- Segment: Elpriser (minigraf vid sidan) -->
  <section class="card" id="elpriser">
    <div class="row row-space">
      <div class="title">Elpriser</div>
      <span class="pill" id="mini-status">laddar…</span>
    </div>

    <div class="priceGrid">
      <div class="priceInfo">
        <p class="meta" style="margin-top:0;">
          Miniöversikt för idag (öre/kWh). Klicka grafen eller knappen för full vy.
        </p>

        <div class="row">
          <a class="btn" href="/spotprices/">Öppna spotpriser</a>
          <button class="btn" type="button" id="refresh">Uppdatera</button>
        </div>

        <div class="meta" id="mini-meta" style="margin-top:10px;"></div>
        <div class="small" id="mini-note" style="margin-top:6px;"></div>
      </div>

      <a href="/spotprices/" class="miniSpark" aria-label="Öppna spotpriser">
        <svg id="spark" viewBox="0 0 1000 160" preserveAspectRatio="none">
          <rect width="1000" height="160" class="spark-bg"></rect>
          <path id="sparkFill" class="spark-fill"></path>
          <path id="sparkLine" class="spark-line"></path>
          <text id="sparkText" x="14" y="26" class="spark-text">Hämtar data…</text>
        </svg>
      </a>
    </div>
  </section>

  <!-- Segment: Information -->
  <section class="card" id="info">
    <div class="row row-space">
      <div class="title">Information</div>
      <span class="pill">sidor</span>
    </div>

    <div class="grid3">
      <div class="tile">
        <div class="tile-title">Publiceringar</div>
        <div class="small">—</div>
        <div class="meta">Lägg upp inlägg/uppdateringar här (sen kan det bli egna sidor).</div>
      </div>

      <div class="tile">
        <div class="tile-title">Fritid</div>
        <div class="small">—</div>
        <div class="meta">Aktiviteter på Rossöhamn, tips, länkar.</div>
      </div>

      <div class="tile">
        <div class="tile-title">Praktisk info</div>
        <div class="small">—</div>
        <div class="meta">...</div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="card">
    <div class="row row-space">
      <div class="small">© <span id="year"></span> Rossöhamn</div>
      <div class="row">
        <a class="navlink" href="#aktuellt">Aktuellt</a>
        <a class="navlink" href="#automation">Automation</a>
        <a class="navlink" href="#elpriser">Elpriser</a>
        <a class="navlink" href="#whatsmyip">What’s my IP</a>
        <a class="navlink" href="/spotprices/">Spotpriser</a>
      </div>
    </div>
  </footer>

</main>

<!-- Kompakt info-widget nere i hörnet -->
<aside class="cornerWidget" id="clientWidget" aria-label="Teknisk info">
  <button class="cwBtn" id="cwToggle" type="button" aria-expanded="false">
    <span class="cwDot" aria-hidden="true"></span>
    <span class="cwTitle">Teknisk info</span>
    <span class="cwState pill" id="client-status-mini">…</span>
  </button>

  <div class="cwPanel" id="cwPanel" hidden>
    <div class="cwRow">
      <div class="small">IP</div>
      <div class="meta cwValue" id="ci-ip">—</div>
    </div>
    <div class="cwRow">
      <div class="small">Plats</div>
      <div class="meta cwValue" id="ci-location">—</div>
    </div>
    <div class="cwRow">
      <div class="small">ISP/ASN</div>
      <div class="meta cwValue" id="ci-isp">—</div>
    </div>
    <div class="cwRow">
      <div class="small">Språk</div>
      <div class="meta cwValue" id="ci-lang">—</div>
    </div>
    <div class="cwRow">
      <div class="small">Tidzon</div>
      <div class="meta cwValue" id="ci-tz">—</div>
    </div>
    <div class="cwRow">
      <div class="small">Skärm</div>
      <div class="meta cwValue" id="ci-screen">—</div>
    </div>

    <div class="cwHint small">
      Visar teknisk information från webbläsaren + publik IP. Inget sparas.
    </div>
  </div>
</aside>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
  const DATA_URL = "/spotprices/history.json";

  function todayKeyStockholm() {
    const parts = new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Europe/Stockholm",
      year: "numeric",
      month: "2-digit",
      day: "2-digit"
    }).formatToParts(new Date());

    const y = parts.find(p => p.type === "year").value;
    const m = parts.find(p => p.type === "month").value;
    const d = parts.find(p => p.type === "day").value;
    return `${y}-${m}-${d}`;
  }

  function drawSpark(points, label) {
    const W=1000, H=160, pad=14;
    const line=document.getElementById("sparkLine");
    const fill=document.getElementById("sparkFill");
    const text=document.getElementById("sparkText");

    if (!points || points.length < 2) {
      line.setAttribute("d", "");
      fill.setAttribute("d", "");
      text.textContent = "Ingen data för idag";
      document.getElementById("mini-meta").textContent = "";
      return;
    }

    const min=Math.min(...points), max=Math.max(...points);
    const span=max-min || 1;
    const xs=(W-pad*2)/(points.length-1);
    const y=v => (H-pad) - ((v-min)/span) * (H-pad*2);

    let d="";
    points.forEach((v,i)=>{ d += `${i?"L":"M"}${pad+i*xs} ${y(v)} `; });

    line.setAttribute("d", d);
    fill.setAttribute("d", `${d}L ${pad+(points.length-1)*xs} ${H-pad} L ${pad} ${H-pad} Z`);
    text.textContent = "";

    document.getElementById("mini-meta").textContent =
      `Idag (${label}) · Min ${min.toFixed(1)} öre/kWh · Max ${max.toFixed(1)} öre/kWh`;
  }

  async function loadMini(){
    const statusEl = document.getElementById("mini-status");
    const noteEl = document.getElementById("mini-note");
    noteEl.textContent = "";

    try{
      statusEl.textContent = "laddar…";
      const r = await fetch(DATA_URL, { cache:"no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();

      const key = todayKeyStockholm();
      const day = j?.days?.[key];

      const pts = (day?.points || [])
        .map(p => p?.oreKwh)
        .filter(Number.isFinite);

      drawSpark(pts, key);

      const updatedAt = j?.meta?.updatedAt;
      document.getElementById("sys-updated").textContent =
        updatedAt ? new Date(updatedAt).toLocaleString("sv-SE") : "—";

      statusEl.textContent = "ok";
      document.getElementById("sys-status").textContent = "OK";

    } catch (e) {
      statusEl.textContent = "fel";
      document.getElementById("sys-status").textContent = "Fel";
      document.getElementById("sparkText").textContent = "Fel: " + (e?.message || String(e));
      noteEl.textContent = "Kontrollera att /spotprices/history.json är åtkomlig och giltig JSON.";
    }
  }

  document.getElementById("refresh").addEventListener("click", loadMini);

  // Shared fetch helper
  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  // What's my IP
  async function loadWhatsMyIp() {
    const status = document.getElementById("ip-status");
    const note = document.getElementById("ip-note");
    const ipPublic = document.getElementById("ip-public");
    const ipIsp = document.getElementById("ip-isp");
    const ipLoc = document.getElementById("ip-loc");

    note.textContent = "";
    status.textContent = "laddar…";
    ipPublic.textContent = "—";
    ipIsp.textContent = "—";
    ipLoc.textContent = "—";

    try {
      const ip = await fetchJson("https://api.ipify.org?format=json");
      ipPublic.textContent = ip?.ip || "okänt";

      try {
        const info = await fetchJson("https://ipapi.co/json/");
        const asn = info?.asn ? info.asn : "";
        const org = info?.org ? info.org : (info?.org_name || "");
        ipIsp.textContent = (asn && org) ? `${asn} · ${org}` : (org || asn || "—");

        const city = info?.city || "";
        const region = info?.region || "";
        const country = info?.country_name || info?.country || "";
        const loc = [city, region, country].filter(Boolean).join(", ");
        ipLoc.textContent = loc || "—";
      } catch {
        note.textContent = "Plats/ISP kunde inte hämtas (blockerad eller otillgänglig).";
      }

      status.textContent = "ok";
    } catch {
      status.textContent = "fel";
      note.textContent = "IP kunde inte hämtas (nätverk/adblocker/CSP).";
    }
  }

  document.getElementById("ip-refresh").addEventListener("click", loadWhatsMyIp);

  // Corner widget: teknisk info (kompakt)
  const cwToggle = document.getElementById("cwToggle");
  const cwPanel = document.getElementById("cwPanel");
  cwToggle.addEventListener("click", () => {
    const expanded = cwToggle.getAttribute("aria-expanded") === "true";
    cwToggle.setAttribute("aria-expanded", String(!expanded));
    cwPanel.hidden = expanded;
  });

  async function loadClientWidget() {
    const statusMini = document.getElementById("client-status-mini");
    statusMini.textContent = "…";

    // Lokalt (alltid)
    const lang = navigator.language || (navigator.languages ? navigator.languages.join(", ") : "—");
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "—";
    const screenInfo = `${window.screen.width}×${window.screen.height} @ ${window.devicePixelRatio || 1}x`;

    document.getElementById("ci-lang").textContent = lang;
    document.getElementById("ci-tz").textContent = tz;
    document.getElementById("ci-screen").textContent = screenInfo;

    // IP + ev. geo (kan blockeras)
    try {
      const ip = await fetchJson("https://api.ipify.org?format=json");
      document.getElementById("ci-ip").textContent = ip?.ip || "okänt";

      try {
        const info = await fetchJson("https://ipapi.co/json/");
        const loc = [info?.city, info?.region, info?.country_name].filter(Boolean).join(", ");
        document.getElementById("ci-location").textContent = loc || "—";
        document.getElementById("ci-isp").textContent = [info?.asn, info?.org].filter(Boolean).join(" · ") || "—";
        statusMini.textContent = "ok";
      } catch {
        document.getElementById("ci-location").textContent = "Ej tillgängligt";
        document.getElementById("ci-isp").textContent = "Ej tillgängligt";
        statusMini.textContent = "delvis";
      }
    } catch {
      document.getElementById("ci-ip").textContent = "Ej tillgängligt";
      document.getElementById("ci-location").textContent = "Ej tillgängligt";
      document.getElementById("ci-isp").textContent = "Ej tillgängligt";
      statusMini.textContent = "delvis";
    }
  }

  // initial load
  loadMini();
  loadWhatsMyIp();
  loadClientWidget();
</script>
</body>
</html>
